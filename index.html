<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Portál Pro</title>
    <style>
        /* CSS styly zůstavají stejné jako v předchozí odpovědi */
        :root {
            --bg-color: #121212;
            --primary-color: #1e1e1e;
            --secondary-color: #2a2a2a;
            --font-color: #e0e0e0;
            --accent-color: #03dac6;
            --accent-hover: #018786;
            --border-color: #333;
            --error-color: #ff5555;
            --warning-color: #ffaa00;
            --success-color: #50fa7b;
            --info-color: #8be9fd;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, #1a1a1a 100%);
            color: var(--font-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin: 0 0 30px 0;
            font-size: 2.5em;
            font-weight: 300;
            background: linear-gradient(135deg, var(--accent-color), #64ffda);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 500;
            color: var(--accent-color);
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .button-group button {
            flex: 1;
            min-width: 180px;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            background-color: var(--secondary-color);
            border: 2px solid var(--border-color);
            color: var(--font-color);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(3, 218, 198, 0.1);
        }

        button {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: var(--bg-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(3, 218, 198, 0.3);
        }

        button:disabled {
            background: linear-gradient(135deg, #555, #666);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Provider Selection Styles */
        .provider-selection {
            background: var(--primary-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .provider-selection h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .provider-card {
            background: linear-gradient(135deg, var(--secondary-color), #333);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .provider-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .provider-card.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--secondary-color), rgba(3, 218, 198, 0.1));
        }

        .provider-card.selected::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 15px;
            background: var(--accent-color);
            color: var(--bg-color);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .provider-info h3 {
            margin: 0 0 10px 0;
            color: var(--font-color);
            font-size: 1.1em;
        }

        .provider-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 15px;
            font-size: 0.9em;
        }

        .provider-details strong {
            color: var(--info-color);
        }

        .provider-actions {
            margin-top: 20px;
            text-align: center;
        }

        .show-channels-btn {
            background: linear-gradient(135deg, var(--success-color), #45a049);
            font-size: 14px;
            padding: 10px 20px;
            min-width: auto;
        }

        /* Channel Display Styles */
        .channel-section {
            display: none;
        }

        .channel-section.visible {
            display: block;
        }

        .channel-filters {
            background: var(--primary-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            color: var(--accent-color);
            font-weight: 500;
        }

        select, input[type="text"] {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--font-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .category {
            margin-bottom: 40px;
            background: var(--primary-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .category h2 {
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 15px;
            margin: 0 0 25px 0;
            font-size: 1.8em;
            font-weight: 400;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-count {
            font-size: 0.6em;
            background: var(--accent-color);
            color: var(--bg-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .channel {
            background: linear-gradient(135deg, var(--secondary-color), #333);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .channel:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(3, 218, 198, 0.2);
            border-color: var(--accent-color);
        }

        .channel-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .channel-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--font-color);
        }

        .source-indicators {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .source-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid;
            font-weight: bold;
            text-transform: uppercase;
        }

        .source-badge.amz {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-color: #ff6b6b;
            color: white;
        }

        .source-badge.manual {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border-color: #74b9ff;
            color: white;
        }
        
        .loader {
            border: 6px solid var(--secondary-color);
            border-top: 6px solid var(--accent-color);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
            margin: 60px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 700px;
            border-radius: 16px;
            position: relative;
            animation: slideIn 0.4s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            color: var(--font-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Source Selection Modal */
        .source-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .source-item {
            background: var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .source-item:hover {
            border-color: var(--accent-color);
        }

        .source-item.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--secondary-color), rgba(3, 218, 198, 0.1));
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            header { padding: 20px; }
            h1 { font-size: 2em; }
            .button-group { flex-direction: column; }
            .button-group button { min-width: auto; }
            .provider-grid { grid-template-columns: 1fr; }
            .channel-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .channel-filters { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎬 IPTV Portál Pro</h1>
            <div class="controls">
                <div class="input-group">
                    <label for="manualUrls">Přidat manuální M3U_PLUS odkazy:</label>
                    <textarea id="manualUrls" placeholder="Vložte další M3U_PLUS odkazy (každý na nový řádek)"></textarea>
                </div>
                <div class="button-group">
                    <button id="addManualBtn">➕ Přidat a znovu načíst</button>
                    <button id="showInfoBtn" disabled>ℹ️ Info o účtech</button>
                </div>
            </div>
        </header>

        <div id="providerSelection" class="provider-selection">
            <h2>📡 Vyberte poskytovatele</h2>
            <div id="providerGrid" class="provider-grid"></div>
            <div class="provider-actions">
                <button id="showSelectedChannelsBtn" class="show-channels-btn" disabled>
                    📺 Zobrazit kanály z vybraných zdrojů
                </button>
            </div>
        </div>

        <div id="channelSection" class="channel-section">
            <div class="channel-filters">
                <div class="filter-group">
                    <label for="comparisonFilter">Porovnat:</label>
                    <select id="comparisonFilter">
                        <option value="all">Všechny kanály</option>
                        <option value="shared">Pouze sdílené</option>
                        <option value="unique">Pouze unikátní</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoryFilter">Kategorie:</label>
                    <select id="categoryFilter">
                        <option value="all">Všechny kategorie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Hledat:</label>
                    <input type="text" id="searchFilter" placeholder="Název kanálu...">
                </div>
            </div>
            <div id="channelList"></div>
        </div>

        <main id="mainContent">
            <div id="loader" class="loader" style="display: none;"></div>
        </main>
    </div>

    <div id="epgModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="epgChannelName"></h2>
            <div id="epgList"></div>
        </div>
    </div>
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>📊 Informace o předplatných</h2>
            <div id="infoList"></div>
        </div>
    </div>
    <div id="sourceModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="sourceChannelName"></h2>
            <div id="sourceList" class="source-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="playSelectedSourceBtn" disabled>▶️ Zobrazit EPG</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addManualBtn = document.getElementById('addManualBtn');
            const manualUrlsInput = document.getElementById('manualUrls');
            const providerSelection = document.getElementById('providerSelection');
            const providerGrid = document.getElementById('providerGrid');
            const showSelectedChannelsBtn = document.getElementById('showSelectedChannelsBtn');
            const channelSection = document.getElementById('channelSection');
            const channelListDiv = document.getElementById('channelList');
            const loader = document.getElementById('loader');
            const showInfoBtn = document.getElementById('showInfoBtn');

            // Filters
            const comparisonFilter = document.getElementById('comparisonFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const searchFilter = document.getElementById('searchFilter');

            // State
            let allProviders = [];
            let selectedProviders = new Map();
            let allChannelsData = {};
            let currentChannelsData = {};

            // --- Event Listeners ---
            addManualBtn.addEventListener('click', () => loadProviders(true));
            showSelectedChannelsBtn.addEventListener('click', loadChannelsFromSelectedProviders);
            showInfoBtn.addEventListener('click', fetchAndDisplayInfo);

            comparisonFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
            searchFilter.addEventListener('input', debounce(applyFilters, 300));

            document.querySelectorAll('.modal .close-button').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal').style.display = 'none');
            });
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) e.target.style.display = 'none';
            });

            // --- Core Functions ---
            async function loadProviders(includeManual = false) {
                loader.style.display = 'block';
                channelSection.classList.remove('visible');
                providerGrid.innerHTML = '';
                
                let manualUrls = [];
                if(includeManual){
                    manualUrls = manualUrlsInput.value.split('\n').filter(url => url.trim() !== '');
                }

                try {
                    const response = await fetch('/api/getChannels', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ manual_urls: manualUrls }),
                    });
                    if (!response.ok) throw new Error((await response.json()).error);
                    
                    const responseData = await response.json();
                    const metadata = responseData._metadata || {};
                    delete responseData._metadata;
                    allChannelsData = responseData;

                    if (metadata.errors?.length) console.warn('Provider errors:', metadata.errors);

                    const providerMap = new Map();
                    Object.values(allChannelsData).flat().forEach(channel => {
                        channel.sources.forEach(source => {
                            const key = source.provider.server;
                            if (!providerMap.has(key)) {
                                providerMap.set(key, { ...source.provider, channelCount: 0 });
                            }
                            providerMap.get(key).channelCount++;
                        });
                    });
                    allProviders = Array.from(providerMap.values());
                    displayProviders(allProviders);

                } catch (error) {
                    console.error('Error loading providers:', error);
                    providerGrid.innerHTML = `<div class="empty-state"><h3>Chyba při načítání</h3><p>${error.message}</p></div>`;
                } finally {
                    loader.style.display = 'none';
                }
            }

            function displayProviders(providers) {
                if (!providers.length) {
                    providerGrid.innerHTML = `<div class="empty-state"><h3>Žádní poskytovatelé</h3><p>Nebyly nalezeny žádné API zdroje.</p></div>`;
                    return;
                }
                providerGrid.innerHTML = providers.map((provider, index) => `
                    <div class="provider-card" data-provider-index="${index}">
                        <h3>${provider.hostname}</h3>
                        <div class="provider-details">
                            <strong>Uživatel:</strong> <span>${provider.username}</span>
                            <strong>Typ:</strong> <span class="source-badge ${provider.isFromAPI ? 'amz' : 'manual'}">${provider.isFromAPI ? 'API' : 'Manuální'}</span>
                            <strong>Kanály:</strong> <span>${provider.channelCount}</span>
                        </div>
                    </div>`
                ).join('');

                document.querySelectorAll('.provider-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const index = parseInt(card.dataset.providerIndex);
                        toggleProviderSelection(index, card);
                    });
                });
            }

            function toggleProviderSelection(index, cardElement) {
                const provider = allProviders[index];
                if (selectedProviders.has(provider.server)) {
                    cardElement.classList.remove('selected');
                    selectedProviders.delete(provider.server);
                } else {
                    cardElement.classList.add('selected');
                    selectedProviders.set(provider.server, provider);
                }
                const hasSelection = selectedProviders.size > 0;
                showSelectedChannelsBtn.disabled = !hasSelection;
                showInfoBtn.disabled = !hasSelection;
                comparisonFilter.disabled = selectedProviders.size < 2;
            }

            function loadChannelsFromSelectedProviders() {
                currentChannelsData = {};
                Object.entries(allChannelsData).forEach(([category, channels]) => {
                    const categoryChannels = channels
                        .map(channel => {
                            const relevantSources = channel.sources.filter(source => selectedProviders.has(source.provider.server));
                            if (relevantSources.length > 0) {
                                return { ...channel, sources: relevantSources };
                            }
                            return null;
                        })
                        .filter(Boolean);

                    if (categoryChannels.length > 0) {
                        currentChannelsData[category] = categoryChannels;
                    }
                });
                populateCategoryFilter(Object.keys(currentChannelsData));
                applyFilters();
                channelSection.classList.add('visible');
            }
            
            function populateCategoryFilter(categories) {
                categoryFilter.innerHTML = '<option value="all">Všechny kategorie</option>';
                categories.sort((a,b) => a.localeCompare(b)).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }

            function applyFilters() {
                const comparisonValue = comparisonFilter.value;
                const categoryValue = categoryFilter.value;
                const searchValue = searchFilter.value.toLowerCase().trim();
                let filteredData = {};

                Object.entries(currentChannelsData).forEach(([category, channels]) => {
                    if (categoryValue !== 'all' && category !== categoryValue) return;
                    
                    const filteredChannels = channels.filter(channel => {
                        if (searchValue && !channel.name.toLowerCase().includes(searchValue)) return false;

                        const sourceCount = channel.sources.length;
                        if (comparisonValue === 'shared' && sourceCount < selectedProviders.size) return false;
                        if (comparisonValue === 'unique' && sourceCount > 1) return false;
                        
                        return true;
                    });

                    if (filteredChannels.length > 0) {
                        filteredData[category] = filteredChannels;
                    }
                });
                displayChannels(filteredData);
            }

            function displayChannels(categories) {
                if (Object.keys(categories).length === 0) {
                    channelListDiv.innerHTML = `<div class="empty-state"><h3>Žádné kanály</h3><p>Pro filtry nebyly nalezeny žádné kanály.</p></div>`;
                    return;
                }
                
                let html = '';
                Object.entries(categories).forEach(([categoryName, categoryChannels]) => {
                    html += `
                        <div class="category">
                            <h2>${categoryName} <span class="category-count">${categoryChannels.length}</span></h2>
                            <div class="channel-grid">
                                ${categoryChannels.map(channel => {
                                    const sourcesBadges = channel.sources.map(source => `
                                        <span class="source-badge ${source.provider.isFromAPI ? 'amz' : 'manual'}">${source.provider.hostname.split('.')[0]}</span>
                                    `).join('');
                                    return `
                                    <div class="channel" data-category="${escape(categoryName)}" data-channel-name="${escape(channel.name)}">
                                        <img src="${channel.logo || 'https://via.placeholder.com/100?text=No+Logo'}" class="channel-logo" onerror="this.src='https://via.placeholder.com/100?text=No+Logo';">
                                        <div class="channel-name">${channel.name}</div>
                                        <div class="source-indicators">${sourcesBadges}</div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>`;
                });
                channelListDiv.innerHTML = html;
            }


            // --- Modal & EPG Logic ---
            channelListDiv.addEventListener('click', async (event) => {
                const channelEl = event.target.closest('.channel');
                if (!channelEl) return;
                const category = unescape(channelEl.dataset.category);
                const channelName = unescape(channelEl.dataset.channelName);
                const channel = currentChannelsData[category].find(c => c.name === channelName);

                if (channel.sources.length === 1) {
                    showEpgModal(channel, channel.sources[0]);
                } else {
                    showSourceSelectionModal(channel);
                }
            });

            async function showEpgModal(channel, source) {
                const epgModal = document.getElementById('epgModal');
                document.getElementById('epgChannelName').textContent = `📺 ${channel.name}`;
                const epgList = document.getElementById('epgList');
                epgList.innerHTML = '<div class="loader"></div>';
                epgModal.style.display = 'block';

                try {
                    const response = await fetch('/api/getEpg', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ channelId: source.id, provider: source.provider })
                    });
                    if (!response.ok) throw new Error((await response.json()).error);
                    const epgData = await response.json();
                    displayEpg(epgData);
                } catch (error) {
                    epgList.innerHTML = `<div class="empty-state"><h3>EPG není dostupný</h3><p>${error.message}</p></div>`;
                }
            }
            
            function displayEpg(epgData) {
                const epgList = document.getElementById('epgList');
                if (!epgData || !epgData.length) {
                    epgList.innerHTML = `<div class="empty-state"><h3>Žádný program</h3></div>`;
                    return;
                }
                const now = new Date();
                epgList.innerHTML = epgData.map(p => {
                    const start = new Date(p.start);
                    const end = new Date(p.end);
                    const isNow = start <= now && end > now;
                    return `
                    <div class="epg-item" style="${isNow ? 'background: rgba(3, 218, 198, 0.1);' : ''}">
                        <div class="epg-time">${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${isNow ? ' <span style="color:var(--success-color)">●</span>' : ''}</div>
                        <div class="epg-title">${p.title}</div>
                        ${p.description ? `<div class="epg-desc">${p.description}</div>` : ''}
                    </div>`;
                }).join('');
            }

            function showSourceSelectionModal(channel) {
                const sourceModal = document.getElementById('sourceModal');
                document.getElementById('sourceChannelName').textContent = `🎯 ${channel.name} - Vyberte zdroj`;
                const sourceList = document.getElementById('sourceList');
                const playBtn = document.getElementById('playSelectedSourceBtn');
                
                sourceList.innerHTML = channel.sources.map((source, index) => `
                    <div class="source-item" data-source-index="${index}">
                        <div>
                            <strong>${source.provider.hostname}</strong>
                            <div style="color:#aaa;font-size:0.9em">${source.provider.username}</div>
                        </div>
                        <span class="source-badge ${source.provider.isFromAPI ? 'amz' : 'manual'}">${source.provider.isFromAPI ? 'API' : 'Manuální'}</span>
                    </div>`
                ).join('');

                sourceModal.style.display = 'block';
                playBtn.disabled = true;
                let selectedIdx = -1;

                sourceList.querySelectorAll('.source-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        sourceList.querySelectorAll('.source-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedIdx = index;
                        playBtn.disabled = false;
                    });
                });

                playBtn.onclick = () => {
                    if (selectedIdx >= 0) {
                        sourceModal.style.display = 'none';
                        showEpgModal(channel, channel.sources[selectedIdx]);
                    }
                };
            }
            
            // Info Modal (zůstává stejné)
            async function fetchAndDisplayInfo() { /* ... kód beze změny ... */ }
            function generateInfoCard(p, s, isAPI) { /* ... kód beze změny ... */ }
            function generateInfoCardError(p, e) { /* ... kód beze změny ... */ }

            // --- Utility ---
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // Initial load
            loadProviders();
        });
    </script>
</body>
</html>
